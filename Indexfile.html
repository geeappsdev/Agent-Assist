<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Case Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // *** START: Custom Tailwind Configuration (COPY TO CSS SETTINGS IN CODEPEN) ***
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4c51bf',
                        'primary-light': '#667eea',
                        'secondary-gray': '#f7fafc',
                        'accent-red': '#f56565',
                        'success-green': '#48bb77',
                        'caution-amber': '#f6e05e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
        // *** END: Custom Tailwind Configuration ***
    </script>
    <style>
        /* *** START: Custom CSS for Styles Panel in CodePen *** */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        /* Setting a dark color explicitly for all output textareas. */
        .output-textarea {
            min-height: 200px;
            resize: vertical;
            color: #1a202c; /* Dark charcoal color (text-gray-900) */
            font-weight: 500;
        }

        .form-textarea, .output-textarea {
            font-size: 16px !important; 
        }

        .action-button {
            display: flex;
            align-items: center;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            border-radius: 9999px; /* rounded-full */
            transition: all 150ms ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .action-button.primary {
            background-color: #4c51bf; /* primary-blue */
            color: white;
        }
        .action-button.primary:hover {
            background-color: #667eea; /* primary-light */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Secondary is now a light, borderless gray for non-copy actions */
        .action-button.secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
        }
        .action-button.secondary:hover {
            background-color: #d1d5db; /* gray-300 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .draggable-panel.dragging {
            opacity: 0.4;
            border: 2px dashed var(--primary-blue);
        }
        
        #popOutButton {
            z-index: 10;
        }

        /* Reusable styles for inputs/textareas for CodePen compatibility */
        .form-textarea {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            transition: all 200ms ease-in-out;
        }
        .form-textarea:focus, .output-textarea:focus {
            outline: none;
            border-color: transparent;
            box-shadow: 0 0 0 2px #4c51bf; /* primary-blue */
        }
        /* *** END: Custom CSS for Styles Panel in CodePen *** */
    </style>
</head>
<body class="bg-secondary-gray font-sans min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- *** START: HTML Structure for HTML Panel in CodePen *** -->
    <div id="app" class="max-w-7xl mx-auto w-full">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl font-bold text-primary-blue">Agent Case Tool</h1>
            <p class="text-gray-600">Analyze the full case context to generate structured support responses.</p>

            <!-- Pop Out Button: Icon Only as requested -->
            <button type="button" onclick="popOutCurrentCase()" id="popOutButton" class="p-2 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition duration-200 shadow-xl absolute top-0 right-0">
                <!-- Icon represents 'External Link' or 'Pop Out' -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </button>
        </header>

        <!-- DISCLAIMER SECTION -->
        <div class="mb-8 w-full p-4 md:p-6 bg-green-100 border-l-4 border-success-green rounded-lg shadow-inner md:max-w-4xl md:mx-auto">
            <h3 class="text-xl font-bold text-green-800 mb-2">Real Link Guarantee & Agent Check</h3>
            <p class="text-sm text-gray-700">
                **Agent Responsibility (Mandatory Check):** You must **always** manually verify the linked articles' content and ensure:
                <ul class="list-disc list-inside mt-2 ml-4 space-y-1 font-semibold text-gray-800">
                    <li>The content in the linked articles is **still relevant** to the user's current issue.</li>
                    <li>No user **PII** (Personally Identifiable Information) remains in the drafts.</li>
                </ul>
            </p>
        </div>
        <!-- END DISCLAIMER SECTION -->

        <!-- Input Form Section (Single Context Box) -->
        <div class="p-6 bg-white rounded-xl shadow-lg mb-8 w-full md:max-w-4xl md:mx-auto">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">What is the case about?</h2>
            
            <form id="assistant-form">
                <textarea id="rawContextInput" 
                    placeholder="Paste the entire case context here for analysis." 
                    rows="15" 
                    class="form-textarea mb-4" 
                    required></textarea>
                
                <div class="flex space-x-3 mt-4">
                    <button type="submit" id="generateButton" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-primary-light transition duration-200 shadow-xl">
                        Analyze and Generate Responses
                    </button>
                </div>

                <div id="loadingIndicator" class="hidden text-center mt-3 text-primary-blue">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing context and generating structured response...
                </div>
                <div id="errorMessage" class="hidden mt-3 p-3 bg-accent-red text-white rounded-lg"></div>
            </form>
        </div>
        
        <!-- Output Section (Five Editable Panels) -->
        <div id="outputContainer" class="mb-8 w-full">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">Generated Outputs</h2>
            
            <!-- Updated grid to handle 5 items (3 per row on large screens) -->
            <div id="outputPanels" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 md:gap-4 lg:grid-cols-3">
                
                <!-- Panel 1: Email Response (NEW DEDICATED COPY-PASTE BOX) -->
                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-er" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <!-- Panel title color changed to gray-700 -->
                        <h3 class="text-lg font-bold text-gray-700">Email Response (Copy)</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-er')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <!-- COPY BUTTON STYLE MODIFIED: FROM GREEN TO DARK GRAY/BLACK -->
                            <button type="button" onclick="copyToClipboard('outputER')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <!-- Text color is handled by the .output-textarea class in the <style> block -->
                    <textarea id="outputER" rows="10" class="output-textarea"></textarea>
                </div>


                <!-- Panel 2: Email Outline (ANALYSIS) -->
                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-eo" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Email Outline (Analysis)</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-eo')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <!-- COPY BUTTON STYLE MODIFIED: FROM LIGHT GRAY/SECONDARY TO DARK GRAY/BLACK -->
                            <button type="button" onclick="copyToClipboard('outputEO')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputEO" rows="10" class="output-textarea"></textarea>
                </div>

                <!-- Panel 3: Chat/RAC notes -->
                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-crn" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Chat/RAC notes</h3>
                         <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-crn')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <!-- COPY BUTTON STYLE MODIFIED: FROM LIGHT GRAY/SECONDARY TO DARK GRAY/BLACK -->
                            <button type="button" onclick="copyToClipboard('outputCRN')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputCRN" rows="10" class="output-textarea"></textarea>
                </div>

                <!-- Panel 4: Internal Note -->
                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-inv" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Internal Note</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-inv')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <!-- COPY BUTTON STYLE MODIFIED: FROM LIGHT GRAY/SECONDARY TO DARK GRAY/BLACK -->
                            <button type="button" onclick="copyToClipboard('outputINV')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputINV" rows="10" class="output-textarea"></textarea>
                </div>

                <!-- Panel 5: Quick Summary -->
                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-qs" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Quick Summary</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-qs')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <!-- COPY BUTTON STYLE MODIFIED: FROM LIGHT GRAY/SECONDARY TO DARK GRAY/BLACK -->
                            <button type="button" onclick="copyToClipboard('outputQS')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputQS" rows="10" class="output-textarea"></textarea>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Modal/Overlay Structure for Expanded View -->
    <div id="expandedModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-gray-900 bg-opacity-75">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-5/6 flex flex-col">
            <!-- Modal Header -->
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold text-primary-blue">Expanded View: </h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-900 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Modal Body (Textarea) -->
            <div class="p-4 flex-grow overflow-hidden">
                <textarea id="modalTextarea" class="w-full h-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent resize-none"></textarea>
            </div>
            <!-- Modal Footer -->
            <div class="p-4 border-t flex justify-end space-x-3">
                <!-- COPY BUTTON STYLE MODIFIED: FROM GREEN TO DARK GRAY/BLACK -->
                <button onclick="copyModalContent()" class="py-2 px-4 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-200 shadow-md">
                    Copy All
                </button>
                <button onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                    Close & Save Changes
                </button>
            </div>
        </div>
    </div>
    <!-- *** END: HTML Structure for HTML Panel in CodePen *** -->

    <script type="text/javascript">
        // *** START: JavaScript Logic for JS Panel in CodePen ***
        // Global variables for Firebase (not currently used but kept for environment compatibility)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Core Application Logic ---

        // API key is now included directly. This must be a valid key to connect to the Google Gen AI service.
        const apiKey = ""; // Leave empty for environment-provided key
        // Base URLs for the two-step process
        const generateApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const searchApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; // Same model, but with search tool

        
        const form = document.getElementById('assistant-form');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const generateButton = document.getElementById('generateButton');
        
        const outputER = document.getElementById('outputER'); // Email Response
        const outputEO = document.getElementById('outputEO'); // Email Outline
        const outputCRN = document.getElementById('outputCRN'); // Chat/RAC Notes
        const outputINV = document.getElementById('outputINV'); // Internal Note
        const outputQS = document.getElementById('outputQS'); // Quick Summary
        
        let generatedData = null;
        let activePanelId = null;

        /**
         * Exponential backoff utility for API retries
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.status === 429) {
                        if (i < maxRetries - 1) {
                            console.warn("Rate limit exceeded (429), retrying in " + delay + "ms...");
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error('API rate limit exceeded after multiple retries.');
                    }
                    
                    if (!response.ok) {
                        const errorBody = await response.text();
                        // Truncate error message for display
                        throw new Error(`API returned status ${response.status}: ${errorBody.substring(0, 100)}...`);
                    }

                    return response.json();

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    if (error.message.includes('JSON')) {
                        console.warn("JSON parsing failed, retrying...");
                    } else if (error.message.includes('API returned status')) {
                        // Throw immediately on fatal API errors (like 400 Bad Request, if not 429)
                        if (!error.message.includes('429')) throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        /**
         * Custom Alert/Message Box function (since alert() is forbidden)
         */
        window.alertUser = function(message, type = 'info') {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertBox = document.createElement('div');
            alertBox.id = 'custom-alert';
            alertBox.textContent = message;
            
            let bgColor = 'bg-primary-light';
            if (type === 'success') bgColor = 'bg-success-green';
            if (type === 'error') bgColor = 'bg-accent-red';
            if (type === 'warning') bgColor = 'bg-caution-amber';

            alertBox.className = `fixed top-4 right-4 z-50 p-3 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 ${bgColor}`;
            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.style.opacity = '0';
                setTimeout(() => alertBox.remove(), 200);
            }, 3000);
        }

        /**
         * Copies content from the specified textarea ID to the clipboard.
         */
        window.copyToClipboard = function(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            try {
                // Use modern clipboard API if available, fall back to execCommand
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        alertUser('Copied to clipboard!', 'success');
                    }).catch(() => {
                        document.execCommand('copy');
                        alertUser('Copied to clipboard! (Fallback)', 'success');
                    });
                } else {
                    document.execCommand('copy');
                    alertUser('Copied to clipboard! (Fallback)', 'success');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                alertUser('Failed to copy text.', 'error');
            }
        }
        
        // --- Modal Functions ---
        
        function getPanelData(panelId) {
            const panel = document.getElementById(panelId);
            const title = panel.querySelector('h3').textContent;
            const textareaId = panel.querySelector('textarea').id;
            const content = document.getElementById(textareaId).value;
            return { title, content, textareaId };
        }

        window.openModal = function(panelId) {
            activePanelId = panelId;
            const { title, content } = getPanelData(panelId);

            document.getElementById('modalTitle').textContent = `Expanded View: ${title}`;
            document.getElementById('modalTextarea').value = content;
            document.getElementById('expandedModal').classList.remove('hidden');
        }

        window.closeModal = function() {
            if (activePanelId) {
                const modalContent = document.getElementById('modalTextarea').value;
                const originalTextareaId = document.getElementById(activePanelId).querySelector('textarea').id;
                
                // Save content back to the original textarea
                document.getElementById(originalTextareaId).value = modalContent;
                activePanelId = null;
                alertUser('Changes saved!', 'info');
            }
            document.getElementById('expandedModal').classList.add('hidden');
        }
        
        window.copyModalContent = function() {
            const textarea = document.getElementById('modalTextarea');
            textarea.select();
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        alertUser('Copied expanded content to clipboard!', 'success');
                    }).catch(() => {
                        document.execCommand('copy');
                        alertUser('Copied expanded content to clipboard! (Fallback)', 'success');
                    });
                } else {
                    document.execCommand('copy');
                    alertUser('Copied expanded content to clipboard! (Fallback)', 'success');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                alertUser('Failed to copy text from expanded view.', 'error');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('expandedModal').classList.contains('hidden')) {
                closeModal();
            }
        });


        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. Gather Input and Validate
            const rawInput = document.getElementById('rawContextInput').value.trim();
            
            if (!rawInput) {
                 errorMessage.textContent = 'Please paste the case context into the input box for analysis.';
                 errorMessage.classList.remove('hidden');
                 return;
            }

            const input = parseContext(rawInput);
            
            // 2. Set UI State
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;
            errorMessage.classList.add('hidden');
            
            // Clear all output areas and show loading text
            const loadingText = 'Analyzing context and generating structured response... Please wait.';
            outputER.value = loadingText;
            outputEO.value = loadingText;
            outputCRN.value = loadingText;
            outputINV.value = loadingText;
            outputQS.value = loadingText;

            let aiAnalysis = { summary: 'NA', realLinks: [] };

            try {
                // Step 1: AI Keyword Extraction & Calibrated Search (New combined step)
                loadingIndicator.textContent = "STEP 1/3: AI analyzing context and extracting search keywords...";
                aiAnalysis = await analyzeContextAndSearch(rawInput);
                
                loadingIndicator.textContent = `STEP 2/3: Searching for relevant Stripe documentation using keywords: ${aiAnalysis.searchKeywords.substring(0, 50)}...`;

                if (aiAnalysis.realLinks.length === 0) {
                     alertUser("Warning: Could not find relevant Stripe links via calibrated search. The email draft will not include any resources.", 'warning');
                } else {
                     loadingIndicator.textContent = `STEP 2/3 Complete. Found ${aiAnalysis.realLinks.length} relevant Stripe links.`;
                }

                // Step 3: Call LLM to Generate Core Content (structured JSON request without tools)
                loadingIndicator.textContent = "STEP 3/3: Generating structured content with verified summary and links...";
                
                // Pass the high-quality, AI-inferred summary and the real links to the final generator
                const rawLLMOutput = await generateLLMContent(input, aiAnalysis.summary, aiAnalysis.realLinks);
                
                // Combine rawLLMOutput with input metadata, and crucially, inject the verified realLinks from Step 1
                generatedData = { 
                    ...rawLLMOutput, 
                    ...input, 
                    // Keep the LLM's summary as it's now fully synchronized with the AI-inferred title
                    summary: rawLLMOutput.summary,
                    // INJECT THE VERIFIED LINKS DIRECTLY FROM STEP 1
                    finalLinks: aiAnalysis.realLinks 
                };
                
                // 3. Format and Display ALL Outputs into editable textareas
                displayAllOutputs(generatedData);
                
            } catch (error) {
                console.error("Generation failed:", error);
                const errorText = `Error: ${error.message}. If the device is restricted from connecting to Google APIs, this service will not function.`;
                errorMessage.textContent = errorText;
                errorMessage.classList.remove('hidden');
                // Set error message in all outputs
                outputER.value = errorText;
                outputEO.value = errorText;
                outputCRN.value = errorText;
                outputINV.value = errorText;
                outputQS.value = errorText;
            } finally {
                // 4. Reset UI State
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
                loadingIndicator.textContent = "Analyzing context and generating structured response...";
            }
        });

        // --- STEP 1: AI Keyword Extraction & Calibrated Search ---
        async function analyzeContextAndSearch(rawInput) {
            
            // 1a. LLM Call 1: Extract Keywords and Title (Summary)
            const keywordSystemPrompt = `You are a sophisticated case analyst. Your task is to analyze the user's case context and provide the definitive core issue title and the best search keywords for finding relevant Stripe documentation. The output must be a single JSON object.
            
            The 'coreIssueTitle' should be a concise, 1-sentence summary of the user's core problem.
            The 'searchKeywords' must be a comma-separated list of 5-7 keywords optimized for a Google search query on Stripe's documentation (e.g., 'payout failed', 'connect on demand', 'identity verification requirements').

            Case Context: "${rawInput}"`;

            const keywordPayload = {
                contents: [{ parts: [{ text: "Extract the core issue title and optimized search keywords from the context." }] }],
                systemInstruction: { parts: [{ text: keywordSystemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "coreIssueTitle": { "type": "STRING", "description": "The AI-inferred concise, 1-sentence summary of the issue." },
                            "searchKeywords": { "type": "STRING", "description": "A comma-separated list of 5-7 optimal keywords for documentation search." }
                        },
                        required: ["coreIssueTitle", "searchKeywords"],
                    }
                }
            };

            const keywordResult = await fetchWithRetry(generateApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(keywordPayload)
            });

            const keywordCandidate = keywordResult.candidates?.[0];
            let titleAndKeywords = { coreIssueTitle: 'NA', searchKeywords: '' };
            if (keywordCandidate && keywordCandidate.content?.parts?.[0]?.text) {
                try {
                    titleAndKeywords = JSON.parse(keywordCandidate.content.parts[0].text);
                } catch (e) {
                     throw new Error("Failed to parse JSON for summary and keywords in step 1.");
                }
            } else {
                 throw new Error("Failed to extract summary and keywords from AI in step 1.");
            }

            const searchString = `Stripe documentation for ${titleAndKeywords.coreIssueTitle} ${titleAndKeywords.searchKeywords}`;
            
            // 1b. Google Search Tool Call
            const searchPayload = {
                contents: [{ parts: [{ text: searchString }] }],
                tools: [{ "google_search": {} }],
            };
            
            try {
                const result = await fetchWithRetry(searchApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(searchPayload)
                });
                
                const candidate = result.candidates?.[0];
                let links = [];

                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    links = groundingMetadata.groundingAttributions
                        .map(attribution => attribution.web?.uri)
                        // Filter for high-quality Stripe documentation/support links
                        .filter(uri => uri && (uri.includes('docs.stripe.com') || uri.includes('support.stripe.com') || uri.includes('stripe.com/docs')))
                        .slice(0, 3); // Take top 3 relevant links
                }
                
                return { summary: titleAndKeywords.coreIssueTitle, searchKeywords: searchString, realLinks: links };

            } catch (error) {
                console.error("Search API failed:", error);
                // Return empty array on failure, forcing LLM to proceed without external links
                return { summary: titleAndKeywords.coreIssueTitle, searchKeywords: searchString, realLinks: [] };
            }
        }

        // --- STEP 2: Generate Structured Content ---
        async function generateLLMContent(input, finalSummary, realLinks) {
            // This is the CRITICAL line. It builds the system prompt's instruction 
            // about links based on the success of the search tool.
            const linkList = realLinks.length > 0 ? realLinks.join('; ') : 'NA - No public Stripe documentation found via search.';

            const systemPrompt = `You are Gee’s Senior, Solution-Oriented Support Assistant AI. Your mission is to generate accurate, empathetic, and well-structured support analyses and communication drafts for Stripe users. You must always use a warm, human-like, professional tone and prevent (DSAT) through Positive Scripting and Never Blaming.
            
            **CRITICAL INSTRUCTION: SUMMARY & LINKS**
            The definitive, AI-inferred summary of the issue is: "${finalSummary}"
            A separate web search was performed, and the following list of real, public Stripe URLs was provided to you: [${linkList}].
            1. You MUST set the 'summary' field in the JSON output to the definitive summary provided above.
            2. You MUST integrate 1-3 of these links into the 'emailBody' using the Markdown hyperlink format (e.g., [Stripe Support Article Title](URL)) to make them clickable.
            3. If the link list is 'NA - No public Stripe documentation found via search.', you must not include any links in the email. DO NOT FABRICATE LINKS.
            
            **Tone & Communication (Highest Priority):**
            - Be genuinely empathetic, acknowledging user frustrations and showing willingness to assist.
            - Use simple English, avoiding jargon or overly formal phrasing.
            - **Positive Scripting Only:** Never use negative words like "unfortunately," "can’t," "system issue," or imply fault. Use "was not able to connect" instead of "system issue" for call problems.
            - Provide realistic assurance, avoiding unverified promises.
            - Personalize every message using the user’s first name and context.
            - Do not proactively mention instant payouts unless relevant.

            **External Email Rules (for 'emailBody' only):**
            1.  **Greeting:** The output emailBody should start with the content immediately following the "Hi [Name]," greeting. The full greeting and closing will be added by the generating function.
            2.  **Formatting:** Must be in simple English paragraphs. Use double line breaks (\\n\\n) to separate paragraphs. **STRICTLY AVOID ALL BULLETS OR NUMBERING in the emailBody.**
            3.  **Link Integration:** Integrate the provided real links naturally into the email text using Markdown hyperlink format (e.g., [Stripe Support Article Title](URL)) to ensure they are clickable.

            **Analysis Rules (for all other fields):**
            1.  **Steps I Took (CRITICAL):** Based on the *entire provided context* (in 'userIssue' field), you must first ANALYZE AND INFER the agent's actions and then list the *ideal, complete, and correct* investigation and resolution steps the agent *should have taken* to fully address the issue. Refine the context into a definitive, actionable list of internal actions taken. Do not add introductory text.
            2.  **Required Email Inclusions (for 'requiredEmailInclusions' field only):** Provide a list of 3-5 specific, bulleted items that the final email must cover based on the user's issue and the resolution strategy. This list ensures all critical points are covered.
            3.  **Formatting:** Use a professional, analytical tone. All section titles should be in **bold**.
            4.  **PII:** Never mention internal teams, tools, or PII. Use "User" (Stripe account holder) or "End User" (non-account holder) or "User’s customer". Use "NA" for missing information.

            Based on the full case context below, generate the following JSON object.

            Full Case Context for Analysis: "${input.userIssue}"`;

            const userQuery = `Analyze the full context to determine the core user issue and the necessary steps taken by the agent. Then, generate the full email and all structured analysis sections. The summary is already provided in the system prompt.`;
            
            // This payload does NOT contain the 'tools' property, allowing for structured JSON output.
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "summary": { "type": "STRING", "description": "The AI-inferred concise analysis of the issue (1-2 sentences). MUST match the summary provided in the system instruction." },
                            "emailBody": { "type": "STRING", "description": "The full email text, in simple English paragraphs, high empathy, starting AFTER 'Hi [Name],' and ending BEFORE 'Best, Gee.'. **Links must be in Markdown format: [Link Title](URL)**." },
                            "stepsITookRaw": { "type": "ARRAY", "description": "The AI-inferred, ideal, and complete investigation steps.", "items": { "type": "STRING" } },
                            "alreadyKnow": { "type": "STRING", "description": "Analysis of what the user already knows based on their communication." },
                            "needToKnow": { "type": "STRING", "description": "Analysis of new, critical information the user should become aware of." },
                            "toDo": { "type": "STRING", "description": "Next actions we want the user to take (emphasize self-service if applicable)." },
                            "outcomeSummary": { "type": "STRING", "description": "Explanation of the resolution approach or final status (1-2 sentences max)." },
                            "dsatAnalysis": { "type": "STRING", "description": "DSAT risk assessment and mitigation strategies (for EO)." },
                            "speculation": { "type": "STRING", "description": "Analysis of possible resolution or underlying causes (for CL/QS/INV)." },
                            "whatTriggeredDissatisfaction": { "type": "STRING", "description": "Context on what caused user's distress (e.g., waiting time, unexpected block)." },
                            "caseStatus": { "type": "STRING", "description": "Current status (e.g., 'Open - Awaiting user action', 'Closed - Resolved')." },
                            "requiredEmailInclusions": { "type": "STRING", "description": "A list of 3-5 specific, bulleted items that the final email must cover based on the user's issue and the resolution strategy."},
                        },
                        required: ["summary", "emailBody", "stepsITookRaw", "alreadyKnow", "needToKnow", "toDo", "outcomeSummary", "dsatAnalysis", "speculation", "whatTriggeredDissatisfaction", "caseStatus", "requiredEmailInclusions"],
                        propertyOrdering: ["summary", "emailBody", "stepsITookRaw", "alreadyKnow", "needToKnow", "toDo", "outcomeSummary", "dsatAnalysis", "speculation", "whatTriggeredDissatisfaction", "caseStatus", "requiredEmailInclusions"]
                    }
                }
            };
            
            const result = await fetchWithRetry(generateApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const candidate = result.candidates?.[0];
            
            if (candidate && candidate.content?.parts?.[0]?.text) {
                const jsonString = candidate.content.parts[0].text;
                return JSON.parse(jsonString);
            } else {
                throw new Error("Invalid response structure or no content from API.");
            }
        }
        
        function parseContext(rawText) {
            // Note: We use a placeholder summary here, but the AI's summary from Step 1 will override it 
            // in the final data structure, resolving the user's initial bug report.
            const data = {
                caseId: 'NA',
                caseLink: 'NA',
                accountId: 'NA',
                userName: 'there',
                userIssue: '',
                investigationSteps: [], 
                relevantLinks: [],
                topic: 'NA',
                accountType: 'NA',
                consent: 'YES',
                checkedRelatedCases: 'YES',
                readEntireThread: 'YES',
                authVerification: 'NA'
            };
            
            const lines = rawText.split('\n').map(line => line.trim());
            let contextBody = []; 
            
            for (const line of lines) {
                if (line.length === 0) continue;

                const parts = line.split(':');
                
                if (parts.length > 1) {
                    const key = parts[0].trim().toLowerCase();
                    const value = parts.slice(1).join(':').trim();

                    if (key === 'case id') {
                        data.caseId = value.toUpperCase() || 'NA';
                        continue;
                    }
                    if (key === 'case link') {
                        data.caseLink = value || 'NA';
                        continue;
                    }
                    if (key === 'account id') {
                        data.accountId = value || 'NA';
                        continue;
                    }
                    if (key === 'user name') {
                        data.userName = value.split(' ')[0] || 'There';
                        continue;
                    }
                    if (key === 'topic') {
                        data.topic = value || 'NA';
                        continue;
                    }
                    if (key === 'user-account type') {
                        data.accountType = value || 'NA';
                        continue;
                    }
                    if (key === 'consent') {
                        data.consent = value.toUpperCase() || 'YES';
                        continue;
                    }
                    if (key === 'verification method') {
                        data.authVerification = value || 'NA';
                        continue;
                    }
                    if (key === 'links') {
                        value.split(/, | /).filter(url => url.startsWith('http')).forEach(url => data.relevantLinks.push(url));
                        continue;
                    }
                    if (key === 'issue' || key === 'steps i took') {
                        contextBody.push(line);
                        continue;
                    }
                }
                
                contextBody.push(line);
            }
            
            data.userIssue = contextBody.join('\n').trim();

            if (data.userIssue.length > 0) {
                 data.investigationSteps.push("Full case context provided. The AI must infer the User Issue and the Agent's Actions from this single block of text.");
            }

            data.investigationSteps = data.investigationSteps.filter(step => step.length > 0);

            // Placeholder summary for initial display, which will be replaced by AI's summary
            data.summary = 'Analyzing...'; 

            return data;
        }

        function formatSteps(steps) {
            return steps.map((step, index) => `${index + 1}. ${step}`).join('\n');
        }

        function formatLinks(links) {
            if (!Array.isArray(links) || links.length === 0) return 'NA';
            return links.map(link => `- ${link.trim()}`).join('\n');
        }

        // Generates the final, copy-paste email response
        function generateER(data) {
            const cleanedBody = data.emailBody.replace(/\n\s*\n/g, '\n\n').trim(); 
            return `Hi ${data.userName},\n\n${cleanedBody}\n\nBest, Gee.`;
        }
        
        // Generates the full EO analysis 
        function generateEO(data) {
            const analysisSections = [
                `**Steps I took**\n${formatSteps(data.stepsITookRaw)}`,
                `**Already know**\n${data.alreadyKnow}`,
                `**Need to know**\n${data.needToKnow}`,
                `**To do**\n${data.toDo}`,
                // Now uses data.finalLinks which is directly injected from the search step
                `**List of links used as references**\n${formatLinks(data.finalLinks)}`,
                `**DSAT Analysis**\n${data.dsatAnalysis}`,
                `**Outcome Summary**\n${data.outcomeSummary}`,
                // **UPDATED** to use the AI-generated content for email inclusions
                `**Information the reply must include**\n${data.requiredEmailInclusions}`, 
                `**Case Status**\n${data.caseStatus}`,
                `**Why is the case open/pending**\n${data.caseStatus.includes('Open') || data.caseStatus.includes('Pending') ? data.caseStatus : 'NA'}`
            ];

            // Use the AI-inferred summary here, which is now guaranteed to be in data.summary
            return `**Case ID: ${data.caseId}**\n**Summary of the issue:** ${data.summary}\n\n**ANALYSIS**\n\n${analysisSections.join('\n\n')}`;
        }

        function generateCRN(data) {
            const relevantIDs = [
                `Case ID: ${data.caseId}`,
                `Account ID: ${data.accountId}`,
                `Topic: ${data.topic}` 
            ].filter(id => !id.endsWith(': NA')).map(id => `- ${id}`).join('\n');
            
            const finalOutcome = data.outcomeSummary.split('\n')[0].trim();
            
            return [
                `**Initial Check: Related cases read?**: ${data.checkedRelatedCases}`,
                `**Have you read through the entire thread?**: ${data.readEntireThread}`,
                `\n**Summary of the issue**:\n${data.summary}`, // Use AI-inferred summary
                `\n**Steps I took**:\n${formatSteps(data.stepsITookRaw)}`,
                `\n**Relevant object IDs**:\n${relevantIDs || 'NA'}`,
                `\n**Final outcome**: ${finalOutcome}`, 
                `\n**Consult**: NA`,
                `\n**Speculation**:\n${data.speculation}`,
                `\n**Why is the case open/pending**:\n${data.caseStatus.includes('Open') || data.caseStatus.includes('Pending') ? data.caseStatus : 'NA'}`,
                `\n**What triggered the user's dissatisfaction and distress?**:\n${data.whatTriggeredDissatisfaction}`,
                `\n**Relevant documents**:\n${formatLinks(data.finalLinks)}` // Now uses injected links
            ].join('\n');
        }
        
        function generateINV(data) {
            const listConcerns = `- ${data.summary}`; // Use AI-inferred summary
            const verificationMethod = data.authVerification || 'NA'; 

            return [
                `**Internal Note Checklist**`,
                `\n**Consent to be recorded**: ${data.consent}`,
                `\n**Verification Method**: ${verificationMethod}`, 
                `\n**User-Account Type**: ${data.accountType}`,
                `\n**User-Account ID**: ${data.accountId}`,
                `\n**Initial Check: Related cases read?**: ${data.checkedRelatedCases}`,
                `\n**Initial Check: Read through the entire thread?**: ${data.readEntireThread}`,
                `\n**List all user's concerns/inquiries**:\n${listConcerns}`,
                `\n**Topic**: ${data.topic}`,
                `\n**Summary of the issue**: ${data.summary}`, // Use AI-inferred summary
                `\n**Steps I took**:\n${formatSteps(data.stepsITookRaw)}`,
                `\n**Check Lumos (RP used)**: NA`, 
                `\n**Check Confluence**: NA`, 
                `\n**Specific Dashboard link (PUBLIC URL)**: Based on Analysis`,
                `\n**Check Public Documentation (Docs, Support, API, etc.)**: ${data.finalLinks.length > 0 ? data.finalLinks.join(', ') : 'NA'}`, // Now uses injected links
                `\n**Final Outcome**: ${data.outcomeSummary}`,
                `\n**Why is the case open/pending**:\n${data.caseStatus.includes('Open') || data.caseStatus.includes('Pending') ? data.caseStatus : 'NA'}`,
                `\n**Information the reply must include**:\n${data.requiredEmailInclusions}` // **UPDATED** to use AI-generated content
            ].join('\n');
        }
        
        function generateQS(data) {
            const relevantIDs = [
                `Case ID: ${data.caseId}`,
                `Account ID: ${data.accountId}`,
            ].join('\n');
            
            const greeting = `Hi ${data.userName},\n\n`;
            // Take the first paragraph of the generated email body for a quick response
            const firstParagraph = data.emailBody.split('\n\n')[0].trim(); 
            const whatCanITellTheUser = `${greeting}${firstParagraph}`;
            
            return [
                `**Summary of the issue**:\n${data.summary}`, // Use AI-inferred summary
                `\n**Case link**:\n${data.caseLink && data.caseLink.includes('admin.corp.stripe.com') ? 'NA (Admin link provided)' : data.caseLink}`,
                `\n**Case ID**:\n${data.caseId}`,
                `\n**Account ID**:\n${data.accountId}`,
                `\n**User-Account ID Platform**:\nNA`,
                `\n**User-Account ID Connected Account**:\nNA`, 
                `\n**Speculation**:\n${data.speculation}`,
                `\n**What Can I tell the user?** (Copy/Paste Draft):\n${whatCanITellTheUser}`,
                `\n**Relevant Stripe resources**:\n${formatLinks(data.finalLinks)}`, // Now uses injected links
                `\n**Relevant IDs**:\n${relevantIDs}`,
                `\n**Why is the case open/pending**:\n${data.caseStatus.includes('Open') || data.caseStatus.includes('Pending') ? data.caseStatus : 'NA'}`,
                `\n**What triggered the user's dissatisfaction and distress?**:\n${data.whatTriggeredDissatisfaction}`,
            ].join('\n');
        }
        
        function displayAllOutputs(data) {
            // data.finalLinks is now directly injected from the search step in form.addEventListener
            
            // Populate all textareas
            outputER.value = generateER(data);
            outputEO.value = generateEO(data);
            outputCRN.value = generateCRN(data);
            outputINV.value = generateINV(data);
            outputQS.value = generateQS(data);
        }

        // --- Drag and Drop Logic ---
        let draggedPanel = null;

        function handleDragStart(e) {
            if (!e.target.closest('.draggable-panel')) {
                return;
            }
            draggedPanel = e.target.closest('.draggable-panel');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedPanel.id);
            setTimeout(() => {
                draggedPanel.classList.add('opacity-40');
            }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('.draggable-panel');

            if (target && target !== draggedPanel) {
                const container = document.getElementById('outputPanels');
                const children = Array.from(container.children).filter(el => el.classList.contains('draggable-panel'));
                
                const draggedIndex = children.indexOf(draggedPanel);
                const targetIndex = children.indexOf(target);

                // Determine if we should insert before or after the target
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / rect.height > 0.5;

                if (draggedIndex < targetIndex) {
                    container.insertBefore(draggedPanel, target.nextSibling);
                } else {
                    container.insertBefore(draggedPanel, target);
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('opacity-40');
            draggedPanel = null;
        }
        
        // --- Popout Feature Logic ---
        
        window.popOutCurrentCase = function() {
            // 1. Collect current output data
            const outputFields = {
                er: document.getElementById('outputER'),
                eo: document.getElementById('outputEO'),
                crn: document.getElementById('outputCRN'),
                inv: document.getElementById('outputINV'),
                qs: document.getElementById('outputQS'),
            };

            // Basic check to see if content has been generated
            const primaryContent = outputFields.er.value.trim();
            if (!primaryContent || primaryContent.includes('loading') || primaryContent.includes('Error')) {
                alertUser('Please analyze the case and generate content before using the Pop Out feature.', 'error');
                return;
            }

            const caseData = {
                title: `Case Snapshot: ${outputFields.eo.value.split('Case ID: ')[1]?.split('\n')[0]?.trim() || 'Analysis'}`,
                outputs: {
                    er: outputFields.er.value,
                    eo: outputFields.eo.value,
                    crn: outputFields.crn.value,
                    inv: outputFields.inv.value,
                    qs: outputFields.qs.value,
                }
            };
            
            
            // 2. Store data in localStorage with a unique key
            const popoutKey = `popout_case_${Date.now()}`;
            localStorage.setItem(popoutKey, JSON.stringify(caseData));

            // 3. Open a new window
            // Use window.location.origin + window.location.pathname for a cleaner URL
            const popoutUrl = `${window.location.origin}${window.location.pathname}?popoutKey=${popoutKey}`;
            const popoutWindow = window.open(popoutUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');

            // 4. Clear input and output for new case in the original window
            if (popoutWindow) {
                document.getElementById('rawContextInput').value = '';
                outputFields.er.value = '';
                outputFields.eo.value = '';
                outputFields.crn.value = '';
                outputFields.inv.value = '';
                outputFields.qs.value = '';
                alertUser('Case popped out successfully! Input and outputs cleared for a new case.', 'success');
            } else {
                alertUser('Pop-up blocked by browser. Please enable pop-ups for this site.', 'error');
            }
        }

        function initializePopoutView(key) {
            const serializedData = localStorage.getItem(key);
            const appElement = document.getElementById('app');
            
            // Reconfigure the main app container for the popout view
            appElement.innerHTML = ''; 
            appElement.classList.remove('max-w-7xl');
            appElement.classList.add('max-w-4xl', 'p-4');
            document.body.classList.remove('p-4', 'md:p-8'); 
            document.getElementById('expandedModal').remove(); // Remove modal from popout view

            if (!serializedData) {
                appElement.innerHTML = '<h1 class="text-3xl font-bold text-accent-red text-center">Error: Case data not found.</h1><p class="text-center mt-4">Please ensure the original window is still open or try popping out the case again.</p>';
                return;
            }

            const caseData = JSON.parse(serializedData);
            const outputs = caseData.outputs;
            
            document.title = caseData.title;

            const popoutHTML = `
                <header class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-primary-blue">${caseData.title}</h1>
                    <p class="text-gray-600 mt-2">Read-Only Snapshot. Close this window when finished.</p>
                </header>
                
                <div class="mb-6 w-full p-4 bg-white border-l-4 border-gray-300 rounded-lg shadow-inner">
                    <p class="text-sm text-gray-700 font-semibold">
                        This is a read-only snapshot. Content in this window is not editable.
                    </p>
                </div>

                <div class="space-y-6">
                    ${createReadonlyPanel('Email Response (Copy)', outputs.er, 'output-popout-er')}
                    ${createReadonlyPanel('Email Outline (Analysis)', outputs.eo, 'output-popout-eo')}
                    ${createReadonlyPanel('Chat/RAC notes', outputs.crn, 'output-popout-crn')}
                    ${createReadonlyPanel('Internal Note', outputs.inv, 'output-popout-inv')}
                    ${createReadonlyPanel('Quick Summary', outputs.qs, 'output-popout-qs')}
                </div>
                
                <div class="text-center mt-8 p-4 bg-white rounded-xl shadow-lg flex justify-center space-x-4">
                    <!-- COPY BUTTON STYLE MODIFIED: FROM GREEN TO DARK GRAY/BLACK -->
                    <button onclick="copyAllPopoutContent()" class="py-3 px-6 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-200 shadow-xl">
                        Copy All Content
                    </button>
                    <button onclick="window.close()" class="py-3 px-6 bg-accent-red text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 shadow-xl">
                        Close Snapshot
                    </button>
                </div>
            `;

            appElement.innerHTML = popoutHTML;
            
            // Helper function to create the panel HTML structure for read-only view
            function createReadonlyPanel(title, content, id) {
                return `
                    <div class="bg-white rounded-xl shadow-lg p-4">
                        <h3 class="text-xl font-bold mb-3 text-primary-blue">${title}</h3>
                        <textarea id="${id}" rows="15" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 resize-y font-mono text-sm" readonly>${content}</textarea>
                        <div class="flex justify-end mt-2">
                            <!-- COPY BUTTON STYLE MODIFIED: FROM LIGHT GRAY/SECONDARY TO DARK GRAY/BLACK -->
                            <button onclick="copyPopoutContent('${id}')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy ${title.split(' ')[0]}
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Global functions used by the popout view (defined here for its context)
        window.copyPopoutContent = function(elementId) {
            const textarea = document.getElementById(elementId);
            if (!textarea) return;
            textarea.select();
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        window.alertUser('Copied content to clipboard!', 'success');
                    });
                } else {
                    document.execCommand('copy');
                    window.alertUser('Copied content to clipboard! (Fallback)', 'success');
                }
            } catch (err) {
                window.alertUser('Failed to copy text.', 'error');
            }
        };

        window.copyAllPopoutContent = function() {
            const allContent = [
                document.getElementById('output-popout-er').value,
                document.getElementById('output-popout-eo').value,
                document.getElementById('output-popout-crn').value,
                document.getElementById('output-popout-inv').value,
                document.getElementById('output-popout-qs').value,
            ].join('\n\n--- OUTPUT SECTION BREAK ---\n\n');
            
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = allContent;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(allContent).then(() => {
                        tempTextarea.remove();
                        window.alertUser('Copied ALL content to clipboard!', 'success');
                    });
                } else {
                    document.execCommand('copy');
                    tempTextarea.remove();
                    window.alertUser('Copied ALL content to clipboard! (Fallback)', 'success');
                }
            } catch (err) {
                window.alertUser('Failed to copy all content.', 'error');
            }
        };


        // --- Event Listener Setup ---
        window.addEventListener('load', () => {
             // --- Popout Logic Check ---
            const urlParams = new URLSearchParams(window.location.search);
            const popoutKey = urlParams.get('popoutKey');
            
            if (popoutKey) {
                // In popout mode: initialize view and exit
                initializePopoutView(popoutKey);
                return;
            }

            // --- Standard App Setup ---
            document.querySelectorAll('.draggable-panel').forEach(panel => {
                panel.addEventListener('dragstart', handleDragStart);
                panel.addEventListener('dragend', handleDragEnd);
            });

            const outputPanels = document.getElementById('outputPanels');
            outputPanels.addEventListener('dragover', handleDragOver);
            outputPanels.addEventListener('drop', handleDrop);
            
            // Apply shared styling to all relevant form inputs, including the new output textareas
            document.querySelectorAll('.form-input, .form-textarea, .output-textarea').forEach(el => {
                // Since this block runs in the environment, we use the classes applied in the HTML.
                // For CodePen, the CSS is separate, but we ensure the CSS styles are clear above.
            });
        });

        // *** END: JavaScript Logic for JS Panel in CodePen ***
    </script>
</body>
</html>
