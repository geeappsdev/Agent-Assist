<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeeApp - Support Assistant Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4c51bf',
                        'primary-light': '#667eea',
                        'secondary-gray': '#f7fafc',
                        'accent-red': '#f56565',
                        'success-green': '#48bb77',
                        'caution-amber': '#f6e05e',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        .output-textarea {
            min-height: 200px;
            resize: vertical;
            color: #1a202c; 
            font-weight: 500;
            white-space: pre-wrap; 
            overflow-wrap: break-word; 
        }

        .form-textarea, .output-textarea {
            font-size: 16px !important; 
        }

        .action-button {
            display: flex;
            align-items: center;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            border-radius: 9999px; /* rounded-full */
            transition: all 150ms ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .action-button.primary {
            background-color: #4c51bf; /* primary-blue */
            color: white;
        }
        .action-button.primary:hover {
            background-color: #667eea; /* primary-light */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .action-button.secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
        }
        .action-button.secondary:hover {
            background-color: #d1d5db; /* gray-300 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .draggable-panel.dragging {
            opacity: 0.4;
            border: 2px dashed #4c51bf; /* Use primary-blue color */
        }
        
        #popOutButton { /* Removed API key button container references */
            z-index: 10;
        }

        .form-textarea {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            transition: all 200ms ease-in-out;
        }
        .form-textarea:focus, .output-textarea:focus {
            outline: none;
            border-color: transparent;
            box-shadow: 0 0 0 2px #4c51bf; /* primary-blue */
        }
         .readonly-textarea {
             white-space: pre-wrap;
             overflow-wrap: break-word;
         }
         /* Custom alert box styling */
         #custom-alert {
             position: fixed;
             top: 1rem;
             right: 1rem;
             z-index: 1000;
             padding: 0.75rem 1rem;
             border-radius: 0.5rem;
             color: white;
             font-weight: 600;
             box-shadow: 0 4px 6px rgba(0,0,0,0.1);
             opacity: 1;
             transition: opacity 0.3s ease-out;
         }
    </style>
</head>
<body class="bg-secondary-gray font-sans min-h-screen flex flex-col items-center p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto w-full">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl font-bold text-primary-blue">GeeApp - Support Assistant</h1>
            <p class="text-gray-600">Senior, Solution-Oriented Support Assistant AI</p>

             <!-- Container for top-right buttons - REMOVED API Key button -->
            <div class="absolute top-0 right-0 flex space-x-2 items-center">
                <!-- Pop Out button remains -->
                <button type="button" onclick="popOutCurrentCase()" id="popOutButton" class="p-2 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition duration-200 shadow-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </button>
            </div>
        </header>

        <div class="mb-8 w-full p-4 md:p-6 bg-yellow-100 border-l-4 border-caution-amber rounded-lg shadow-inner md:max-w-4xl md:mx-auto">
            <h3 class="text-xl font-bold text-yellow-800 mb-2">Important Disclaimer &amp; Verification Checklist</h3>
            <p class="text-sm text-gray-700">
                The content generated includes links found via Google Search based on the case analysis.
                <br><br>
                **Agent Responsibility (Mandatory Check):** You must **always** manually verify the generated output for:
                <ul class="list-disc list-inside mt-2 ml-4 space-y-1 font-semibold text-gray-800">
                    <li>Accidental inclusion of **internal links or proprietary information**.</li>
                    <li>Any user **PII** (Personally Identifiable Information) in the drafts.</li>
                    <li>Ensuring all links provided are **relevant, correct, and public** Stripe pages.</li>
                     <li>**API Key:** This tool requires a Google Gemini API key to be manually inserted into the `apiKey` variable in the script before deployment/use.</li>
                </ul>
            </p>
        </div>

        <div class="p-6 bg-white rounded-xl shadow-lg mb-8 w-full md:max-w-4xl md:mx-auto">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">What is the case about?</h2>
            
            <form id="assistant-form">
                <textarea id="rawContextInput" 
                    placeholder="Paste the entire case context here, including metadata like 'Topic:', 'Case ID:', 'Account ID:', 'User Name:'. The AI will infer the topic if not provided." 
                    rows="15" 
                    class="form-textarea mb-4" 
                    required></textarea>
                
                <div class="flex space-x-3 mt-4">
                    <button type="submit" id="generateButton" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-primary-light transition duration-200 shadow-xl">
                        Analyze and Generate Responses
                    </button>
                </div>

                <div id="loadingIndicator" class="hidden text-center mt-3 text-primary-blue">
                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing context and generating structured response...
                </div>
                <div id="errorMessage" class="hidden mt-3 p-3 bg-accent-red text-white rounded-lg"></div>
            </form>
        </div>
        
        <div id="outputContainer" class="mb-8 w-full">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">Generated Outputs</h2>
            
            <div id="outputPanels" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 md:gap-4 lg:grid-cols-3">
                
                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-er" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-gray-700">Email Response (Copy)</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-er')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <button type="button" onclick="copyToClipboard('outputER')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputER" rows="10" class="output-textarea"></textarea>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-eo" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">PWR email resources</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-eo')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <button type="button" onclick="copyToClipboard('outputEO')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputEO" rows="10" class="output-textarea"></textarea>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-crn" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Chat/RAC notes</h3>
                         <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-crn')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <button type="button" onclick="copyToClipboard('outputCRN')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputCRN" rows="10" class="output-textarea"></textarea>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-inv" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Internal Note</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-inv')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <button type="button" onclick="copyToClipboard('outputINV')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputINV" rows="10" class="output-textarea"></textarea>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-4 draggable-panel cursor-move" id="panel-qs" draggable="true">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold text-primary-blue">Quick Summary</h3>
                        <div class="flex space-x-2">
                            <button type="button" onclick="openModal('panel-qs')" class="action-button primary">
                                Expand
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4M4 20l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                            </button>
                            <button type="button" onclick="copyToClipboard('outputQS')" class="action-button bg-gray-800 text-white hover:bg-gray-700">
                                <svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <textarea id="outputQS" rows="10" class="output-textarea"></textarea>
                </div>
            </div>
        </div>

    </div>
    
    <div id="expandedModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-gray-900 bg-opacity-75">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-5/6 flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold text-primary-blue">Expanded View: </h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-900 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 flex-grow overflow-hidden">
                <textarea id="modalTextarea" class="w-full h-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-blue focus:border-transparent resize-none"></textarea>
            </div>
            <div class="p-4 border-t flex justify-end space-x-3">
                <button onclick="copyModalContent()" class="py-2 px-4 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-200 shadow-md">
                    Copy All
                </button>
                <button onclick="closeModal()" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                    Close & Save Changes
                </button>
            </div>
        </div>
    </div>
    <!-- *** END: HTML Structure *** -->

    <script type="text/javascript">
        // *** START: JavaScript Logic ***
        
        // --- API Key Handling (Manual Placeholder) ---
        // IMPORTANT: Replace the empty string with your actual Google Gemini API key
        // BEFORE deploying or running this file. DO NOT commit your key to public GitHub.
        const apiKey = ""; // <--- PASTE YOUR API KEY HERE (KEEP THE QUOTES)
        
        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Construct API URLs using the apiKey variable
        let generateApiUrl = '';
        let searchApiUrl = '';

        function updateApiUrls() {
            if (apiKey) {
                const model = 'gemini-2.5-flash-preview-09-2025';
                generateApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                searchApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            } else {
                 generateApiUrl = '';
                 searchApiUrl = '';
            }
        }
        
        // --- Core Application Logic ---
        const form = document.getElementById('assistant-form');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const generateButton = document.getElementById('generateButton');
        
        const outputER = document.getElementById('outputER'); 
        const outputEO = document.getElementById('outputEO'); 
        const outputCRN = document.getElementById('outputCRN'); 
        const outputINV = document.getElementById('outputINV'); 
        const outputQS = document.getElementById('outputQS'); 
        
        let activePanelId = null;

        /**
         * Exponential backoff utility for API retries (calls Google directly)
         */
        async function fetchWithRetry(payload, maxRetries = 5) { // Removed url parameter
            let delay = 1000;
           
            for (let i = 0; i < maxRetries; i++) {
                 // Check if apiKey is present (user needs to add it manually)
                 if (!apiKey) {
                      throw new Error("API Key is missing in the code. Please edit the 'apiKey' variable in the script.");
                 }
                 updateApiUrls(); // Ensure URLs are constructed
                 
                 const targetUrl = payload.tools ? searchApiUrl : generateApiUrl;
                 if (!targetUrl) { // Should only happen if apiKey is still empty
                      throw new Error("API Key is missing. Cannot construct API URL.");
                 }

                try {
                    const response = await fetch(targetUrl, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    // Specific check for auth errors indicating a bad key
                    if (response.status === 401 || response.status === 403) {
                         throw new Error(`API Key invalid or missing permissions (Status ${response.status}). Please check the key entered in the code.`);
                    }
                    if (response.status === 429) { 
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error('API rate limit exceeded after multiple retries.');
                    }
                    
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Google API returned status ${response.status}: ${errorBody.substring(0, 150)}...`);
                    }

                    return response.json(); 

                } catch (error) {
                     // If it's an API key error, throw immediately and don't retry
                     if (error.message.includes("API Key invalid") || error.message.includes("API Key is missing")) {
                          console.error("API Key error:", error.message);
                           errorMessage.textContent = error.message; 
                           errorMessage.classList.remove('hidden');
                           generateButton.disabled = true; // Keep disabled until page reload after fixing key
                          throw error; 
                     }
                    if (i === maxRetries - 1) {
                        console.error("Fetch failed after max retries:", error);
                        throw error; 
                    }
                    // Non-logging retry for other errors
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error("fetchWithRetry failed unexpectedly."); 
        }

        /**
         * Custom Alert/Message Box function
         */
        window.alertUser = function(message, type = 'info') {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();
            const alertBox = document.createElement('div');
            alertBox.id = 'custom-alert';
            alertBox.textContent = message;
            let bgColor = 'bg-primary-light';
            if (type === 'success') bgColor = 'bg-success-green';
            if (type === 'error') bgColor = 'bg-accent-red';
            if (type === 'warning') bgColor = 'bg-caution-amber';
            alertBox.className = `fixed top-4 right-4 z-50 p-3 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 ${bgColor}`;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.style.opacity = '0';
                setTimeout(() => alertBox.remove(), 300); // Faster fade out
            }, 3000);
        }

        /**
         * Copies content to clipboard using execCommand
         */
        window.copyToClipboard = function(elementId) {
            const textarea = document.getElementById(elementId);
            if (!textarea) return; 
            
            const originalStyle = textarea.style.cssText;
            const originalTabIndex = textarea.getAttribute('tabindex');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            textarea.style.opacity = '0';
            textarea.style.display = 'block'; 
            textarea.removeAttribute('disabled');
            textarea.setAttribute('tabindex', '-1'); 

            textarea.select();
            textarea.setSelectionRange(0, 99999); 

            let successful = false;
            try {
                successful = document.execCommand('copy');
                if (successful) {
                    alertUser('Copied to clipboard!', 'success');
                } else {
                     throw new Error('Copy command was not successful.');
                }
            } catch (err) {
                console.error('Copy failed:', err);
                alertUser('Failed to copy text automatically. Please copy manually.', 'error');
            } finally {
                 textarea.style.cssText = originalStyle;
                 if (originalTabIndex) { textarea.setAttribute('tabindex', originalTabIndex); } 
                 else { textarea.removeAttribute('tabindex'); }
                 if (window.getSelection) { window.getSelection().removeAllRanges(); } 
                 else if (document.selection) { document.selection.empty(); }
            }
        }
        
        // --- Modal Functions ---
        function getPanelData(panelId){const panel=document.getElementById(panelId); const title=panel.querySelector('h3').textContent; const textareaId=panel.querySelector('textarea').id; const content=document.getElementById(textareaId).value; return{title,content,textareaId};}
        window.openModal=function(panelId){activePanelId=panelId; const{title,content}=getPanelData(panelId); document.getElementById('modalTitle').textContent=`Expanded View: ${title}`; document.getElementById('modalTextarea').value=content; document.getElementById('expandedModal').classList.remove('hidden');}
        window.closeModal=function(){if(activePanelId){const modalContent=document.getElementById('modalTextarea').value; const originalTextareaId=document.getElementById(activePanelId).querySelector('textarea').id; document.getElementById(originalTextareaId).value=modalContent; activePanelId=null; alertUser('Changes saved!','info');} document.getElementById('expandedModal').classList.add('hidden');}
        window.copyModalContent=function(){const textarea=document.getElementById('modalTextarea'); textarea.select(); try{document.execCommand('copy'); alertUser('Copied expanded content to clipboard!','success');} catch(err){console.error('Copy failed:',err); alertUser('Failed to copy text from expanded view.','error');}}
        document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&!document.getElementById('expandedModal').classList.contains('hidden')){closeModal();}});


        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check API key before submitting (it relies on the hardcoded variable now)
            if (AIzaSyDAquQitlWL0sHiq97Z1T91eW2bFRduAFM) {
                 errorMessage.textContent = "API Key is missing in the code. Please edit the 'AIzaSyDAquQitlWL0sHiq97Z1T91eW2bFRduAFM' variable in the script before running.";
                 errorMessage.classList.remove('hidden');
                 generateButton.disabled = true; // Keep button disabled
                 return; 
            } else {
                 errorMessage.classList.add('hidden'); // Hide message if key is present
                 generateButton.disabled = false; // Ensure button is enabled if key IS present
            }


            const rawInput = document.getElementById('rawContextInput').value.trim();
            if (!rawInput) { 
                 errorMessage.textContent = 'Please paste the entire case context into the input box for analysis.';
                 errorMessage.classList.remove('hidden');
                 return; 
            }

            const parsedContext = parseContext(rawInput); 
            
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true; // Disable during processing
            errorMessage.classList.add('hidden'); // Hide previous errors
            
            const loadingText = 'Analyzing context and generating structured response... Please wait.';
            outputER.value = loadingText; outputEO.value = loadingText; outputCRN.value = loadingText; outputINV.value = loadingText; outputQS.value = loadingText;

            let initialAnalysisResult = { topic: 'NA', summary: 'NA' }; 
            let searchResults = { realLinks: [] }; 

            try {
                // --- 3-Step Process (Direct to Google API) ---

                // Step 1: Initial AI Analysis
                loadingIndicator.textContent = "STEP 1/3: Analyzing context to determine topic and summary...";
                initialAnalysisResult = await analyzeInitialContext(rawInput);
                let topicToSearch = initialAnalysisResult.topic !== 'NA' ? initialAnalysisResult.topic : ''; 

                // Step 2: Search for Links
                loadingIndicator.textContent = `STEP 2/3: Searching for relevant Stripe links based on topic "${topicToSearch || 'context'}..."`;
                if (topicToSearch) {
                     searchResults = await searchForLinks(topicToSearch); 
                     if (searchResults.realLinks.length === 0) { 
                          alertUser(`Warning: Could not find relevant Stripe links for topic "${topicToSearch}". Analysis fields may lack resources.`, 'warning');
                     } 
                     else { 
                          loadingIndicator.textContent = `STEP 2/3 Complete. Found ${searchResults.realLinks.length} relevant Stripe links.`;
                     }
                } else { 
                     alertUser("Warning: Could not determine topic from context. Skipping link search.", 'warning');
                     loadingIndicator.textContent = `STEP 2/3 Skipped. No topic determined.`;
                }

                // Step 3: Generate Final Content
                loadingIndicator.textContent = "STEP 3/3: Generating final structured content...";
                const llmResponse = await generateFinalOutputs(parsedContext, rawInput, initialAnalysisResult, searchResults.realLinks);
                
                // 4. Display Outputs
                displayAllOutputs(llmResponse);
                
            } catch (error) {
                console.error("Generation failed:", error);
                // Display specific error (includes API key check)
                const errorText = `Error: ${error.message}. Please ensure the API key in the code is correct and has permissions. Check console for details.`; 
                errorMessage.textContent = errorText;
                errorMessage.classList.remove('hidden');
                outputER.value = errorText; outputEO.value = errorText; outputCRN.value = errorText; outputINV.value = errorText; outputQS.value = errorText;
                 // Keep button disabled if it was an API key error
                 generateButton.disabled = error.message.includes("API Key"); 
            } finally {
                // 5. Reset UI
                loadingIndicator.classList.add('hidden');
                 // Only re-enable button if API key is present AND no API key error occurred
                 if (apiKey && !errorMessage.textContent.includes("API Key")) {
                      generateButton.disabled = false; 
                 } else {
                      generateButton.disabled = true; // Keep disabled if key is missing/invalid
                 }
                loadingIndicator.textContent = "Analyzing context and generating structured response..."; 
            }
        });

        // --- STEP 1: Initial AI Analysis (Direct to Google) ---
        async function analyzeInitialContext(rawInput) {
            const analysisSystemPrompt = `You are "GeeApp", Gee’s Senior Support Assistant AI. Analyze the user's case context. Determine the main 'topic' (e.g., Payouts, Verification, Disputes, Connect Onboarding, ACH Debit) and provide a concise 1-sentence 'summary' of the core issue. Output ONLY a JSON object with these two keys: {"topic": "...", "summary": "..."}.

Case Context: "${rawInput}"`;


            const analysisPayload = {
                contents: [{ parts: [{ text: "Determine the topic and summary." }] }],
                systemInstruction: { parts: [{ text: analysisSystemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT",
                        properties: {
                            "topic": { "type": "STRING", "description": "The main topic category (e.g., Payouts, Verification)." },
                            "summary": { "type": "STRING", "description": "A concise 1-sentence summary of the core issue." }
                        },
                        required: ["topic", "summary"],
                    }
                }
            };

            try {
                // *** Uses fetchWithRetry which now handles direct Google calls ***
                const result = await fetchWithRetry(analysisPayload); 
                
                const candidate = result.candidates?.[0]; 
                if (candidate && candidate.content?.parts?.[0]?.text) {
                     let analysisData = JSON.parse(candidate.content.parts[0].text);
                     analysisData.topic = analysisData.topic?.trim() || 'NA';
                     analysisData.summary = analysisData.summary?.trim().replace(/^["']|["']$/g, '') || 'Could not determine summary.';
                     return analysisData;
                } else {
                     console.error("Received unexpected response structure from Google during initial analysis:", result);
                     throw new Error("Google API returned invalid data structure for initial analysis.");
                }
            } catch (error) {
                console.error("Initial analysis failed:", error);
                // Propagate specific error (like API key error)
                throw new Error(`Initial analysis failed: ${error.message}`); 
            }
        }

        // --- STEP 2: Search Function (Direct to Google) ---
        async function searchForLinks(topic) {
            const searchString = `${topic} Stripe`; 
            const searchPayload = {
                contents: [{ parts: [{ text: searchString }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: "Find the most relevant official Stripe documentation or support pages related to the user's query." }] }
            };
            
            try {
                 // *** Uses fetchWithRetry which now handles direct Google calls ***
                const result = await fetchWithRetry(searchPayload); 

                const candidate = result.candidates?.[0];
                let links = [];
                 const groundingMetadata = candidate?.groundingMetadata;
                 if (groundingMetadata && groundingMetadata.groundingAttributions) {
                     links = groundingMetadata.groundingAttributions
                         .map(attribution => attribution.web?.uri)
                         .filter(uri => uri && (uri.startsWith('https://docs.stripe.com') || uri.startsWith('https://support.stripe.com') || uri.startsWith('https://stripe.com/docs')))
                         .slice(0, 3); 
                 }
                 else if (candidate && candidate.content?.parts?.[0]?.text) {
                      const textResponse = candidate.content.parts[0].text;
                      const foundUrls = textResponse.match(/https?:\/\/[^\s]+/g) || [];
                      links = foundUrls
                          .filter(url => url.includes('stripe.com/docs') || url.includes('support.stripe.com'))
                          .slice(0, 3);
                          if(links.length > 0) console.warn("Used fallback link extraction from text response.");
                 }

                return { realLinks: links }; 

            } catch (error) {
                console.error(`Search API failed for topic "${topic}":`, error);
                 // Propagate specific error
                 throw new Error(`Link search failed: ${error.message}`);
            }
        }

        // --- STEP 3: Generate Final Structured Content (Direct to Google) ---
        async function generateFinalOutputs(parsedContext, fullCaseContext, initialAnalysisResult, realLinks) {
            
            const linkListString = realLinks.length > 0 ? realLinks.map(link => `- ${link}`).join('\n') : 'NA';
            const finalSummary = initialAnalysisResult.summary; 

            // *** GEEAPP PERSONA SYSTEM PROMPT (Includes all previous refinements) ***
            const systemPrompt = `You are "GeeApp", Gee’s Senior, Solution-Oriented Support Assistant AI.
Your mission is to generate accurate, empathetic, and well-structured support analyses and communication drafts for Stripe users based on the full case context provided.
You must always use a warm, human-like, professional tone. 
**Empathy Guidance:** Acknowledge the user's situation concisely ("I understand...", "I see...") and pivot quickly to the solution or next steps. Avoid overly negative language that dwells on the problem (e.g., avoid "frustrating," "inconvenient," "unfortunately"). Focus on being helpful, clear, and action-oriented.
Prevent dissatisfaction (DSAT) through Positive Scripting and Never Blaming.
You MUST add a double newline (\\n\\n) between each field in the analysis formats (EO, CL, INV, QS) for readability.

**CRITICAL INSTRUCTION: SUMMARY & LINKS**
The definitive summary of the issue is: "${finalSummary}"
The following list of real, public Stripe URLs was found via search:
${linkListString}
1. You MUST use the definitive summary for the 'Summary of the issue' field.
2. You MUST *NOT* include any links in the 'Email Response' body.
3. You MUST include the provided links (formatted as a simple list with '-' prefixes as shown above, or 'NA' if none) in the relevant fields for 'PWR email resources', 'Chat/RAC notes', 'Internal Note', and 'Quick Summary'.
4. DO NOT FABRICATE LINKS.
5. Use the 'Parsed Context' data (Case ID, Account ID, User Name) where specified in the formats.

**Response Formats Definitions (Generate the full text for these five):**

1.  **Email Response (for "Email Response (Copy)" panel):**
    * Purpose: Complete, user-facing email.
    * Content: Start with "Hi ${parsedContext.userName}," (or "Hi there,"). Paragraphs only. No bullets. End with "Best, Gee".
    * Tone: Positive empathy (acknowledge then solve). Simple English.
    * Links: NO LINKS.

2.  **EO (Email Outline) (for "PWR email resources" panel):**
    * Purpose: Detailed agent analysis + resources.
    * Structure (Use \\n\\n between fields):
        * **Case ID:** ${parsedContext.caseId}\n\n
        * **Summary of the issue:** ${finalSummary}\n\n
        * **Relevant PWR resources:**\n${linkListString}\n\n
        * **Analysis:**\n\n
        * **Steps I took:**\n[Numbered list: Infer agent's ideal actions from context]\n\n
        * **Information in the reply must include:**\n[Bulleted list: Critical points for email]\n\n
        * **Already know:**\n[What user stated/knows]\n\n
        * **Need to know:**\n[New info for user]\n\n
        * **What the user need to do:**\n[User's next steps]\n\n
        * **Outcome Summary:**\n[Resolution state]\n\n
        * **DSAT analysis:**\n[Risk + mitigation]

3.  **CL (Concise List) (for "Chat/RAC notes" panel):**
    * Purpose: Simplified internal outline.
    * Structure (Use \\n\\n between fields):
        * **Have you checked all related cases?:** ${parsedContext.checkedRelatedCases}\n\n
        * **Have you read through the entire thread?:** ${parsedContext.readEntireThread}\n\n
        * **Summary of the issue:** ${finalSummary}\n\n
        * **Steps I took:**\n[Numbered list: Infer agent's ideal actions]\n\n
        * **Relevant object IDs:**\n[List IDs from context]\n\n
        * **Final outcome:**\n[Resolution state]\n\n
        * **Relevant documents:**\n${linkListString}

4.  **INV (Internal Note) (for "Internal Note" panel):**
    * Purpose: Detailed internal checklist.
    * Structure (Use \\n\\n between fields):
        * **Internal Note checklist**\n\n
        * **Consent to be recorded:** ${parsedContext.consent}\n\n
        * **Authentication/Verification PIN/PII?:** ${parsedContext.authVerification}\n\n
        * **User-Account Type:** ${parsedContext.accountType}\n\n
        * **User-Account ID:** ${parsedContext.accountId}\n\n
        * **Have you checked all related cases?** ${parsedContext.checkedRelatedCases}\n\n
        * **Have you read through the entire thread?** ${parsedContext.readEntireThread}\n\n
        * **List all user's concerns/inquiries:**\n[Bulleted list from context]\n\n
        * **Topic:** ${initialAnalysisResult.topic}\n\n  
        * **Summary of the issue:** ${finalSummary}\n\n
        * **Steps I took:**\n[Numbered list: Infer agent's ideal actions]\n\n
        * **Check Lumos (RP used):** NA\n\n
        * **Check Confluence:** NA\n\n
        * **Specific Dashboard link:** ${parsedContext.caseLink}\n\n
        * **Check Public Documentation:**\n${linkListString}\n\n
        * **Final Outcome:**\n[Category] - [Summary]\n\n
        * **Why is the case open/pending:**\n[Rationale]

5.  **QS (Quick Summary) (for "Quick Summary" panel):**
    * Purpose: Brief summary + CSAT/Distress assessment.
    * Structure (Use \\n\\n between fields):
        * **Summary of the issue:** ${finalSummary}\n\n
        * **Case link:** ${parsedContext.caseLink}\n\n
        * **Case ID:** ${parsedContext.caseId}\n\n
        * **Account ID:** ${parsedContext.accountId}\n\n
        * **User-Account ID Platform:** NA\n\n
        * **User-Account ID Connected Account:** NA\n\n
        * **Speculation:**\n[Possible resolution]\n\n
        * **What Can I tell the user?:**\n[Draft response, paragraph, empathetic, no links]\n\n
        * **Relevant Stripe resources:**\n${linkListString}\n\n
        * **Relevant IDs:**\n[List IDs from context]\n\n
        * **Will this case be a CSAT?:**\n[YES/NO/UNCERTAIN]\n\n
        * **Is the user distressed?:**\n[YES/NO]

**Full Case Context for Analysis:**
"""
${fullCaseContext}
"""
`;


            const userQuery = `Generate the five outputs (Email Response, EO format, CL format, INV format, QS format) as a single JSON object based on the full case context and the critical instructions in the system prompt. Ensure all analysis fields (EO, CL, INV, QS) have double newlines between each field.`;
            
            // Payload for the final generation call
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT",
                        properties: {
                            "generatedER": { "type": "STRING", "description": "The full, user-facing email." },
                            "generatedEO": { "type": "STRING", "description": "The complete EO format text." },
                            "generatedCL": { "type": "STRING", "description": "The complete CL format text." },
                            "generatedINV": { "type": "STRING", "description": "The complete INV format text." },
                            "generatedQS": { "type": "STRING", "description": "The complete QS format text." }
                        },
                        required: ["generatedER", "generatedEO", "generatedCL", "generatedINV", "generatedQS"]
                    }
                }
            };
            
            try {
                 // *** Uses fetchWithRetry which now handles direct Google calls ***
                const result = await fetchWithRetry(payload); 

                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonString = candidate.content.parts[0].text;
                    try {
                        return JSON.parse(jsonString); 
                    } catch (parseError) { 
                         console.error("Failed to parse JSON response from final AI call:", jsonString, parseError);
                         throw new Error("AI returned invalid JSON data for final outputs.");
                    }
                } else { 
                    console.error("Invalid response structure received from final API call:", result);
                    throw new Error("Invalid response structure or no content from final API call.");
                }
            } catch (error) { 
                 console.error("Final content generation failed:", error);
                 // Propagate specific error
                 throw new Error(`Final content generation failed: ${error.message}`);
            }
        }
        
        // Parses metadata - unchanged
         function parseContext(rawText){const data={caseId:'NA',caseLink:'NA',accountId:'NA',userName:'there',topic:'NA',accountType:'NA',consent:'YES',checkedRelatedCases:'YES',readEntireThread:'YES',authVerification:'NA'};const lines=rawText.split('\n').map(line=>line.trim());for(const line of lines){if(line.length===0)continue;const parts=line.split(':');if(parts.length>1){const key=parts[0].trim().toLowerCase();const value=parts.slice(1).join(':').trim();if(key==='case id')data.caseId=value.toUpperCase()||'NA';else if(key==='case link')data.caseLink=value||'NA';else if(key==='account id')data.accountId=value||'NA';else if(key==='user name')data.userName=value.split(' ')[0]||'there';else if(key==='topic')data.topic=value||'NA';else if(key==='user-account type')data.accountType=value||'NA';else if(key==='consent')data.consent=value.toUpperCase()||'YES';else if(key==='verification method')data.authVerification=value||'NA';}} if(data.topic==='')data.topic='NA';return data;}


        // Displays outputs - unchanged
        function displayAllOutputs(responseData){if(!responseData){console.error("Received null/undefined data in displayAllOutputs");const errorMsg="Error: Failed to receive valid data from AI.";outputER.value=errorMsg;outputEO.value=errorMsg;outputCRN.value=errorMsg;outputINV.value=errorMsg;outputQS.value=errorMsg;return;} outputER.value=responseData.generatedER||"Error generating Email Response.";outputEO.value=responseData.generatedEO||"Error generating PWR email resources.";outputCRN.value=responseData.generatedCL||"Error generating Chat/RAC notes.";outputINV.value=responseData.generatedINV||"Error generating Internal Note.";outputQS.value=responseData.generatedQS||"Error generating Quick Summary.";}


        // --- Drag and Drop Logic (Unchanged) ---
        let draggedPanel = null;
        function handleDragStart(e){if(!e.target.closest('.draggable-panel'))return;draggedPanel=e.target.closest('.draggable-panel');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/html',draggedPanel.id);setTimeout(()=>{if(draggedPanel)draggedPanel.classList.add('opacity-40');},0);}
        function handleDragOver(e){e.preventDefault();const target=e.target.closest('.draggable-panel');if(target&&draggedPanel&&target!==draggedPanel){const container=document.getElementById('outputPanels');const children=Array.from(container.children).filter(el=>el.classList.contains('draggable-panel'));const draggedIndex=children.indexOf(draggedPanel);const targetIndex=children.indexOf(target);if(draggedIndex===-1||targetIndex===-1)return;const rect=target.getBoundingClientRect();const next=(e.clientY-rect.top)/rect.height>0.5;if(next){container.insertBefore(draggedPanel,target.nextSibling);}else{container.insertBefore(draggedPanel,target);}}}
        function handleDrop(e){e.preventDefault();if(draggedPanel){draggedPanel.classList.remove('opacity-40');} draggedPanel=null;}
        function handleDragEnd(e){if(e.target.classList.contains('draggable-panel')){e.target.classList.remove('opacity-40');} draggedPanel=null;}

        
        // --- Popout Feature Logic (Unchanged) ---
        window.popOutCurrentCase = function() { /* ... */ }
        function initializePopoutView(key) { /* ... */ }
        window.copyPopoutContent = function(elementId) { /* ... */ };
        window.copyAllPopoutContent = function() { /* ... */ };
         window.popOutCurrentCase=function(){const outputFields={er:document.getElementById('outputER'),eo:document.getElementById('outputEO'),crn:document.getElementById('outputCRN'),inv:document.getElementById('outputINV'),qs:document.getElementById('outputQS')};const primaryContent=outputFields.er.value.trim();if(!primaryContent||primaryContent.includes('loading')||primaryContent.includes('Error')){alertUser('Please analyze the case and generate content before using the Pop Out feature.','error');return;} let caseTitle='Case Snapshot';try{let eoContent=outputFields.eo.value;let match=eoContent.match(/Case ID:\s*([^\n]+)/);if(!match||!match[1]||match[1].trim()==='NA'){const qsContent=outputFields.qs.value;match=qsContent.match(/Case ID:\s*([^\n]+)/);} if(match&&match[1]&&match[1].trim()!=='NA'){caseTitle=`Case Snapshot: ${match[1].trim()}`;}}catch(e){console.error("Error parsing Case ID for popout title:",e);} const caseData={title:caseTitle,outputs:{er:outputFields.er.value,eo:outputFields.eo.value,crn:outputFields.crn.value,inv:outputFields.inv.value,qs:outputFields.qs.value}};const popoutKey=`popout_case_${Date.now()}`;localStorage.setItem(popoutKey,JSON.stringify(caseData));const popoutUrl=`${window.location.origin}${window.location.pathname}?popoutKey=${popoutKey}`;const popoutWindow=window.open(popoutUrl,'_blank','width=800,height=600,scrollbars=yes,resizable=yes');if(popoutWindow){document.getElementById('rawContextInput').value='';outputFields.er.value='';outputFields.eo.value='';outputFields.crn.value='';outputFields.inv.value='';outputFields.qs.value='';alertUser('Case popped out successfully! Input and outputs cleared for a new case.','success');}else{alertUser('Pop-up blocked by browser. Please enable pop-ups for this site.','error');}}
         function initializePopoutView(key){const serializedData=localStorage.getItem(key);const appElement=document.getElementById('app');appElement.innerHTML='';appElement.classList.remove('max-w-7xl');appElement.classList.add('max-w-4xl','p-4');document.body.classList.remove('p-4','md:p-8');const modal=document.getElementById('expandedModal');if(modal)modal.remove(); if(!serializedData){appElement.innerHTML='<h1 class="text-3xl font-bold text-accent-red text-center">Error: Case data not found.</h1><p class="text-center mt-4">Please ensure the original window is still open or try popping out the case again.</p>';return;} const caseData=JSON.parse(serializedData);const outputs=caseData.outputs;document.title=caseData.title;const popoutHTML=`<header class="text-center mb-6"><h1 class="text-2xl font-bold text-primary-blue">${caseData.title}</h1><p class="text-gray-600 mt-2">Read-Only Snapshot. Close this window when finished.</p></header><div class="mb-6 w-full p-4 bg-white border-l-4 border-gray-300 rounded-lg shadow-inner"><p class="text-sm text-gray-700 font-semibold">This is a read-only snapshot. Content in this window is not editable.</p></div><div class="space-y-6">${createReadonlyPanel('Email Response (Copy)',outputs.er,'output-popout-er')}${createReadonlyPanel('PWR email resources',outputs.eo,'output-popout-eo')}${createReadonlyPanel('Chat/RAC notes',outputs.crn,'output-popout-crn')}${createReadonlyPanel('Internal Note',outputs.inv,'output-popout-inv')}${createReadonlyPanel('Quick Summary',outputs.qs,'output-popout-qs')}</div><div class="text-center mt-8 p-4 bg-white rounded-xl shadow-lg flex justify-center space-x-4"><button onclick="copyAllPopoutContent()" class="py-3 px-6 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-200 shadow-xl">Copy All Content</button><button onclick="window.close()" class="py-3 px-6 bg-accent-red text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 shadow-xl">Close Snapshot</button></div>`;appElement.innerHTML=popoutHTML;function createReadonlyPanel(title,content,id){return `<div class="bg-white rounded-xl shadow-lg p-4"><div class="flex justify-between items-center mb-3"><h3 class="text-xl font-bold text-primary-blue">${title}</h3><button onclick="copyPopoutContent('${id}')" class="action-button bg-gray-800 text-white hover:bg-gray-700"><svg class="w-4 h-4 mr-1 inline-block" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-2 0V4H9a1 1 0 01-1-1z"></path><path d="M3 8a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1V8z"></path></svg>Copy ${title.split(' ')[0]}</button></div><textarea id="${id}" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 h-64 resize-y font-mono text-sm readonly-textarea" readonly>${content}</textarea></div>`;}}
         window.copyPopoutContent=function(elementId){const textarea=document.getElementById(elementId);if(!textarea)return;textarea.select();try{document.execCommand('copy');window.alertUser('Copied content to clipboard!','success');} catch(err){window.alertUser('Failed to copy text.','error');}};
         window.copyAllPopoutContent=function(){const allContent=[document.getElementById('output-popout-er').value,document.getElementById('output-popout-eo').value,document.getElementById('output-popout-crn').value,document.getElementById('output-popout-inv').value,document.getElementById('output-popout-qs').value].join('\n\n--- OUTPUT SECTION BREAK ---\n\n');const tempTextarea=document.createElement('textarea');tempTextarea.value=allContent;document.body.appendChild(tempTextarea);tempTextarea.select();try{document.execCommand('copy');tempTextarea.remove();window.alertUser('Copied ALL content to clipboard!','success');} catch(err){tempTextarea.remove();window.alertUser('Failed to copy all content.','error');}};


        // --- Event Listener Setup ---
        window.addEventListener('load', () => {
             // *** REMOVED API Key check on load *** // Assumes key is manually set in the const apiKey = "" line before running.
             updateApiUrls(); // Still needed to construct URLs initially

             // Show error and disable button permanently if key is missing in the code
             if (!apiKey) {
                 errorMessage.textContent = "API Key is missing in the code. Please edit the 'apiKey' variable in the script.";
                 errorMessage.classList.remove('hidden');
                 generateButton.disabled = true;
             } else {
                 generateButton.disabled = false; // Enable if key is present
             }


             // --- Popout Logic Check ---
            const urlParams = new URLSearchParams(window.location.search);
            const popoutKey = urlParams.get('popoutKey');
            if (popoutKey) { initializePopoutView(popoutKey); return; }

            // --- Standard App Setup ---
            document.querySelectorAll('.draggable-panel').forEach(panel => {
                panel.addEventListener('dragstart', handleDragStart);
                panel.addEventListener('dragend', handleDragEnd);
            });
            const outputPanels = document.getElementById('outputPanels');
            outputPanels.addEventListener('dragover', handleDragOver);
            outputPanels.addEventListener('drop', handleDrop);
            document.querySelectorAll('.form-input, .form-textarea, .output-textarea').forEach(el => {});
        });

        // *** END: JavaScript Logic ***
    </script>
</body>
</html>
